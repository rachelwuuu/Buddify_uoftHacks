# -*- coding: utf-8 -*-
"""MBTI_Predictor.ipynb

Automatically generated by Colaboratory.

Original file is located at
    https://colab.research.google.com/drive/1B7DpxIOISyMnZRIarhtOwWhWqZ2TxX5C
"""

# Commented out IPython magic to ensure Python compatibility.
import pandas as pd
import numpy as np
import re
from tqdm import tqdm

# plotting
# import seaborn as sns
# import matplotlib.pyplot as plt
# %matplotlib inline
import nltk
#nltk.download('stopwords')
#nltk.download('wordnet')

# read data
data = pd.read_csv('dataset/personality-test.csv')

def get_types(row):
    t=row['type']

    I = 0; N = 0
    T = 0; J = 0

    if t[0] == 'I': I = 1
    elif t[0] == 'E': I = 0
    else: print('I-E incorrect')

    if t[1] == 'N': N = 1
    elif t[1] == 'S': N = 0
    else: print('N-S incorrect')

    if t[2] == 'T': T = 1
    elif t[2] == 'F': T = 0
    else: print('T-F incorrect')

    if t[3] == 'J': J = 1
    elif t[3] == 'P': J = 0
    else: print('J-P incorrect')
    return pd.Series( {'IE':I, 'NS':N , 'TF': T, 'JP': J })

data = data.join(data.apply (lambda row: get_types (row),axis=1))

b_Pers = {'I':0, 'E':1, 'N':0, 'S':1, 'F':0, 'T':1, 'J':0, 'P':1}
b_Pers_list = [{0:'I', 1:'E'}, {0:'N', 1:'S'}, {0:'F', 1:'T'}, {0:'J', 1:'P'}]

def translate_personality(personality):
    # transform mbti to binary vector

    return [b_Pers[l] for l in personality]

def translate_back(personality):
    # transform binary vector to mbti personality

    s = ""
    for i, l in enumerate(personality):
        s += b_Pers_list[i][l]
    return s

##### Compute list of subject with Type | list of comments
from nltk.stem import PorterStemmer, WordNetLemmatizer
from nltk.corpus import stopwords

# We want to remove these from the psosts
unique_type_list = ['INFJ', 'ENTP', 'INTP', 'INTJ', 'ENTJ', 'ENFJ', 'INFP', 'ENFP',
       'ISFP', 'ISTP', 'ISFJ', 'ISTJ', 'ESTP', 'ESFP', 'ESTJ', 'ESFJ']

unique_type_list = [x.lower() for x in unique_type_list]


# Lemmatize
stemmer = PorterStemmer()
lemmatiser = WordNetLemmatizer()

# Cache the stop words for speed
cachedStopWords = stopwords.words("english")

def pre_process_data(data, remove_stop_words=True, remove_mbti_profiles=True):

    list_personality = []
    list_posts = []
    len_data = len(data)
    i=0

    bar = tqdm(desc='preprocessing data',total=len_data)
    for row in data.iterrows():

        i+=1
        bar.update(1)
        # if (i % 500 == 0 or i == 1 or i == len_data):
        #     print("%s of %s rows" % (i, len_data))

        ##### Remove and clean comments
        posts = row[1].posts
        temp = re.sub('http[s]?://(?:[a-zA-Z]|[0-9]|[$-_@.&+]|(?:%[0-9a-fA-F][0-9a-fA-F]))+', ' ', posts)
        temp = re.sub("[^a-zA-Z]", " ", temp)
        temp = re.sub(' +', ' ', temp).lower()
        if remove_stop_words:
            temp = " ".join([lemmatiser.lemmatize(w) for w in temp.split(' ') if w not in cachedStopWords])
        else:
            temp = " ".join([lemmatiser.lemmatize(w) for w in temp.split(' ')])

        if remove_mbti_profiles:
            for t in unique_type_list:
                temp = temp.replace(t,"")

        type_labelized = translate_personality(row[1].type)
        list_personality.append(type_labelized)
        list_posts.append(temp)
    bar.close()

    list_posts = np.array(list_posts)
    list_personality = np.array(list_personality)
    return list_posts, list_personality


list_posts, list_personality  = pre_process_data(data, remove_stop_words=True)

from sklearn.feature_extraction.text import TfidfTransformer
from sklearn.feature_extraction.text import CountVectorizer


# Posts to a matrix of token counts
cntizer = CountVectorizer(analyzer="word",
                             max_features=1500,
                             tokenizer=None,
                             preprocessor=None,
                             stop_words=None,
                             max_df=0.7,
                             min_df=0.1)

# Learn the vocabulary dictionary and return term-document matrix
print("CountVectorizer...")
X_cnt = cntizer.fit_transform(list_posts)

# Transform the count matrix to a normalized tf or tf-idf representation
tfizer = TfidfTransformer()

print("Tf-idf...")
# Learn the idf vector (fit) and transform a count matrix to a tf-idf representation
X_tfidf =  tfizer.fit_transform(X_cnt).toarray()

feature_names = list(enumerate(cntizer.get_feature_names()))

type_indicators = [ "IE: Introversion (I) / Extroversion (E)", "NS: Intuition (N) – Sensing (S)",
                   "FT: Feeling (F) - Thinking (T)", "JP: Judging (J) – Perceiving (P)"  ]



# A few few tweets and blog post
my_posts  = """'Okay... My ESFJ SO has admitted that he thinks that he is not as committed as I am to our relationship. His reasoning: I think you get more attached to people than me. He also says that he doesn't...|||Extremely Loud, Incredibly Close - JS Foer Just a very touching book.|||This is going to be more like the confession thread. Red velvet cupcake Piece of ice cream cake Mint chocolate Clif bars A margarita pizza Popcorn  Conclusion: I'm disgusting.  I had to fill...|||Ohhh I should have phrased that differently.. I have a tendency to lack sense... Some people have accused me of talking 'in code', although that's fairly different. Anyway, I meant that I like INFPs...|||Most of the time, the statements that upset me seem to be ones that weren't thought out completely by that person. I tend to think it's a waste of time to reply to a person who simply regurgitates a...|||wanting to take care of that person; finding that even their flaws are endearing; abandoning logic at times to try to understand how they think/feel... as far as love languages go, gift giving is my...|||I take one of my favorite china tea cups with me to coffee shops. It's a little different, but there definitely is a difference in the taste (vs. the paper cups). I also keep fine dissection scissors...|||I collect tea cups. The crap that fills my room, minus the book shelves, makes me second guess my Tness.|||Emma Goldman.. is it possible to make that a slutty Halloween costume?  http://www.differenceengines.com/wp-content/uploads/2010/10/emma-goldman-1890.jpg|||Finding flowers on my doorstep... and waking up to a gray sky morning (I've missed the rain).|||Kind of a Funny Story. It was okay; I expected more depth.|||The last two I met are both prone to isolation, which is probably facilitated by their WoW preoccupations and the reason for each of their Xanax prescriptions. I probably wouldn't have interacted...|||I love INFPs. The only trait that makes me uneasy is the tendency for some of them to put themselves down too often. I'm not very good with the whole Aw, that's not true... You're very.. Nice.....|||1. 23 2. F 3. 5|||Thanks :)  It wasn't as bad as I thought it was going to be. In the beginning one of the girls said to do something crazy, which resulted in a spider monkey imitation. After that it was easier to...|||I have felt myself mellowing and it scares me a little; I still want to become ridiculously annoyed when the wrongfully arrogant AMSA student raises his voice when talking about patients mistaking...|||Very much like the anthro/free people/urban outfitters look ... but I also like the crisp, mostly black, pea coat, boots, and pulled-back hair look.  It's fun to throw a bunch of random things...|||Isn't Bones a sensor?|||The only habit I'm always aware of in those situations... is sitting/standing in a location that allows me to watch people without being easily watched in return. My default conversations are...|||Stop saying sorry|||There are some people who have mannerisms that I find really interesting. People who carry themselves... delicately(?) really fascinate me... as well as people who seem to be unaware of how annoying...|||I'm not an INFP, but my confession is... I like you guys more than other INTPs.|||I saw a status about eye-bleaching... which made me think eye bleach trays.. and a mishap that resulted in an entirely white eyeball.. like the Clear Eyes commercial with Ben Stein.. and now that...|||I sing cheesy pop songs way too often.. but only when alone, of course. Every now and then I worry about going into coma or dying... and people finding a ridiculous number of recordings on this...|||After I was prescribed Vyvanse and the spaciness remained... I was tested for absence seizures. I think (at least imo) that inner thoughts trump external environment.. in terms of awareness...|||I.got.glasses.:wink:|||The old, leafless oak tree by my house looks like a giant neuron.. PET scan it.|||The outspoken, just-hopped-on-the-bandwagon... self-proclaimed 'activist'... with nothing but an arrogant, unquestioning allegiance to whatever soundbite was Tweeted that morning.|||I catch glimpses of children in some of my professors and coworkers. It overwhelms the room.. sparkling. In certain laughs, it's as though we're all falling into a JM Barrie daydream. I love the...|||So far this is sleepless night number three.. it's not preferred. Driving is terrifying after even one night of no sleep.. but I'm also a major space case. I do remember liking a night without sleep...|||I love Balmorhea.. I think voiceless songs allow me to feel more in music, but lyrics are also very important... and tend to satisfy the thinking side.. (the ones that are enjoyed).|||Anti-anxiety meds have helped one of my friends very much. She's 28.  on the other hand..  Remeron.. which I reluctantly agreed to try.. will fuck you up. Don't do it.. especially at your age.....|||Do this...   http://www.phillypaws.org/images/contentEditor/8_300-149.JPG  ... I don't know how to not be rigid.. especially when aware of someone taking pictures.. so if you have any tips on...|||do anything that distracts from thinking... a temporary escape... when that fails, i sleep for a few days.. usually wake up in a bearable state by then. it's not ideal, but it keeps me here.|||I accept theistic evolution, yet relate to what you are describing. When you say this makes you obsessed with death.. I wonder if you mean what I would have meant by that statement? At least once a...|||Somewhere in Time... I was really young when I saw it, but definitely remember it being very depressing. Life is Beautiful Up in the Air... didn't expect that one. Bella Beyond the Gates|||1. Men who stare = taser-buying-inspiration (more relevant to experience than personality type... I think? Although.. I guess thinking that in that act they are using lower-level...|||Certainly. Although, I'd say this extends to include ALL people. Every interaction is a game- a state of mind that is a stranger to the thought process that is present during solitude. Only in very...|||An endless source of apathy The ability to pretend, to take on opposing stances-- being able to emotionally disconnect from the topic at hand Not understanding/knowing how to manage emotional...|||Didn't someone somewhat famous do that?  All of Them- How many are we talking???! :unsure:|||Sounds fantastic :tongue:    I like the name Emily|||:blushed:  Only if you're the guy in the video... or resemble him in any aspect!|||Haha I didn't know flannel was a turn-on!   Ohhhh wow... man in that video = LOL|||Eyy Captain! :tongue: You're officially my first PC buddy.|||Now: Sipping on chamomile tea, hearing remnants of the violin notes that have ventured through my window, slipper-ed feet sitting upon a stack of books, feeling my hair wave as it dries, smelling the...|||Home made AND Secret Family Recipe. So Secret that the words must be capitalized. When growing up in the middle of nowhere, you learn to be old fashioned (and like it, too). I've noticed most buy...|||Yay!! Happy people!! :laughing:  California: I wish I agreed.:sad: People from my old home down south were much, much nicer than they have been here. In the one month I've lived about the bay, I've...|||Ohhh! the bonds of flannel! I wore flannel, worn jeans, knee-high rain boots, crazy windblown wavy hair, and my sister's peacoat (I should mention: the arms are too short) when my aunt invited me to...|||Thank you! Is Azrael your name? It's beautiful. My niece is named Avriel. My sisters and I always wished we had been given unique names.|||'Still new to the bay. Still very new here. Meeting new people would be amazing. Coming from a close-knit, small, outdoorsy community, I haven't met as many friendly people as I had hoped. I don't...'"""

import joblib

loaded_model = joblib.load('model_ckpt/pima.pickle.dat')

def post_to_personality(post: str):

    # The type is just a dummy so that the data prep fucntion can be reused
    mydata = pd.DataFrame(data={'type': ['INFJ'], 'posts': [post]})

    my_posts, _ = pre_process_data(mydata, remove_stop_words=True)

    my_X_cnt = cntizer.transform(my_posts)
    my_X_tfidf = tfizer.transform(my_X_cnt).toarray()


    result = []
    for l in range(len(type_indicators)):
        # print("%s ..." % (type_indicators[l]))

        y_pred = loaded_model.predict(my_X_tfidf)
        result.append(y_pred[0])
        # print("* %s prediction: %s" % (type_indicators[l], y_pred))

    rval = translate_back(result)
    print("The result is: ", rval)

    return rval




if __name__ == '__main__':
    post_to_personality(my_posts)
